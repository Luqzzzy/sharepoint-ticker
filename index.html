<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Interactive Personalized Ticker</title>
<style>
  :root {
    --bg: #002C73;      /* dark theme background per request */
    --fg: #ffffff;      /* base foreground (dark theme) */
    --muted: #c6d4ee;
    --accent: #4cc2ff;
    --danger: #ff6b6b;
    --speed: 35s;       /* animation duration */
    --font-size: 14px;
    --item-gap: 2rem;
    --offset: 0px;      /* keyboard nudge offset */
  }

  [data-theme="light"] {
    --bg: #ffffff;      /* keep light theme white */
    --fg: #111111;      /* strong contrast on white */
    --muted: #5a6b82;
    --accent: #0b6cff;
  }

  body {
    margin: 0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
    background: var(--bg);
    color: var(--fg);
  }

  .ticker-wrap {
    border-top: 1px solid rgba(0,0,0,0.12);
    border-bottom: 1px solid rgba(0,0,0,0.12);
    background: transparent;
    padding: .35rem .5rem;
  }

  /* Row holds inline controls (left) + ticker viewport (right) */
  .ticker-row {
    display: flex;
    align-items: center;
    gap: .5rem;
  }

  /* Controls on LEFT now */
  .ticker-controls {
    display: inline-flex;
    align-items: center;
    gap: .35rem;
    flex: 0 0 auto;
  }

  .icon-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 34px;
    height: 34px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.18);
    background: rgba(255,255,255,0.12);
    color: #fff;
    cursor: pointer;
    font-size: 16px;
    line-height: 1;
  }
  .icon-btn:hover { background: rgba(255,255,255,0.18); }
  [data-theme="light"] .icon-btn {
    border-color: rgba(0,0,0,0.18);
    background: rgba(0,0,0,0.06);
    color: #111;
  }
  [data-theme="light"] .icon-btn:hover { background: rgba(0,0,0,0.10); }

  /* Viewport masks the overflowing lane */
  .ticker-viewport {
    position: relative;
    overflow: hidden;
    flex: 1 1 auto;
    min-width: 0; /* prevents flex overflow issues */
  }

  .ticker {
    display: flex;
    gap: var(--item-gap);
    width: max-content;
    padding: .25rem .25rem .4rem .25rem;
    animation: tickerScroll var(--speed) linear infinite;
    will-change: transform;
    transform: translateX(calc(var(--offset)));
  }

  /* Paused states: manual pause OR hover-pause */
  .ticker.paused,
  .ticker.hover-paused {
    animation-play-state: paused;
  }

  @keyframes tickerScroll {
    from { transform: translateX(calc(0px + var(--offset))); }
    to   { transform: translateX(calc(-50% + var(--offset))); } /* duplicated content → seamless */
  }

  .ticker-item {
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: .45rem;
    font-size: var(--font-size);
    font-weight: 800; /* bold */
    /* Dark theme: bold white with black shadow */
    color: #ffffff;
    text-shadow:
      0 1px 0 rgba(0,0,0,0.85),
      0 0 6px rgba(0,0,0,0.55);
  }
  /* Light theme: bold black with white shadow */
  [data-theme="light"] .ticker-item {
    color: #111111;
    text-shadow:
      0 1px 0 rgba(255,255,255,0.95),
      0 0 4px rgba(255,255,255,0.8);
  }

  .ticker a {
    color: inherit; /* inherit bold theme-aware color */
    text-decoration: none;
    border-bottom: 1px dotted rgba(255,255,255,0.35);
  }
  [data-theme="light"] .ticker a {
    border-bottom-color: rgba(0,0,0,0.35);
  }
  .ticker a:hover {
    color: var(--accent);
    border-color: var(--accent);
    text-shadow: none; /* cleaner on hover accent */
  }

  .tag {
    padding: .05rem .4rem;
    border-radius: 6px;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: .4px;
    background: rgba(255,255,255,0.18);
    color: #e9f0ff;
    font-weight: 700;
    text-shadow: none; /* keep tags crisp */
  }
  [data-theme="light"] .tag {
    background: rgba(0,0,0,0.12);
    color: #0b1a2a;
  }
  .tag.News { outline: 1px solid rgba(76,194,255,.35); }
  .tag.Events { outline: 1px solid rgba(77,255,136,.35); }
  .tag.Alerts { outline: 1px solid rgba(255,136,136,.35); }
  .tag.Sports { outline: 1px solid rgba(255,209,102,.35); }
  .tag.Stocks { outline: 1px solid rgba(195,155,255,.35); }

  /* Personalization panel (ensure it stays on top & clickable) */
  .panel {
    position: fixed;
    right: 1rem;
    bottom: 1rem;
    width: 320px;
    max-width: calc(100vw - 2rem);
    background: rgba(0,0,0,0.25);
    border: 1px solid rgba(255,255,255,0.18);
    border-radius: 12px;
    padding: .9rem;
    display: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    backdrop-filter: blur(6px);
    z-index: 2147483647;   /* top of stack */
    pointer-events: auto;  /* accept clicks */
    color: #fff;
    isolation: isolate;    /* safety against blending/overlays */
  }
  .panel.open { display: block; }
  [data-theme="light"] .panel {
    background: rgba(255,255,255,0.98);
    border-color: rgba(0,0,0,0.12);
    color: #111;
  }
  .panel h3 {
    margin: 0 0 .5rem 0;
    font-size: 16px; 
  }
  .row { display: flex; align-items: center; justify-content: space-between; gap: .5rem; margin: .5rem 0; }
  .chips { display: flex; flex-wrap: wrap; gap: .4rem; }
  .chip {
    border: 1px solid rgba(255,255,255,0.18);
    background: rgba(255,255,255,0.10);
    padding: .25rem .55rem;
    border-radius: 999px;
    font-size: 12px;
    cursor: pointer;
    user-select: none;
  }
  [data-theme="light"] .chip {
    border-color: rgba(0,0,0,0.15);
    background: rgba(0,0,0,0.06);
  }
  .chip.active { outline: 2px solid var(--accent); }
  .range { width: 100%; }
  .subtle { color: var(--muted); font-size: 12px; }

  .sr-only {
    position: absolute !important;
    height: 1px; width: 1px;
    overflow: hidden; clip: rect(1px, 1px, 1px, 1px);
    white-space: nowrap; border: 0; padding: 0; margin: -1px;
  }
</style>
</head>
<body data-theme="dark">
  <div class="ticker-wrap" aria-label="News Ticker">
    <div class="ticker-row">
      <!-- Inline controls (LEFT) — icons only -->
      <div class="ticker-controls">
        <!-- Pause/Play button icon only -->
        <button id="pauseBtn" class="icon-btn" aria-pressed="false" aria-label="Pause ticker" title="Pause/Play">
          ⏸
        </button>
        <!-- Personalize (settings) button icon only -->
        <button id="gearBtn" class="icon-btn" aria-haspopup="dialog" aria-controls="prefsPanel" aria-expanded="false" aria-label="Personalize" title="Personalize">
          ⚙️
        </button>
      </div>

      <!-- Ticker viewport (RIGHT) -->
      <div class="ticker-viewport" aria-live="polite">
        <div id="tickerLane" class="ticker" role="list" tabindex="0"></div>
      </div>
    </div>
  </div>

  <!-- Personalization Panel -->
  <div id="prefsPanel" class="panel" role="dialog" aria-modal="false" aria-labelledby="prefsTitle" hidden>
    <h3 id="prefsTitle">Personalize Ticker</h3>

    <div class="row">
      <div>Categories</div>
      <div class="chips" id="categoryChips" role="group" aria-label="Filter categories"></div>
    </div>

    <div class="row">
      <label for="speedRange">Speed</label>
      <input id="speedRange" class="range" type="range" min="10" max="60" step="5" />
    </div>
    <div class="row">
      <label for="fontRange">Font size</label>
      <input id="fontRange" class="range" type="range" min="12" max="20" step="1" />
    </div>

    <div class="row">
      <span>Theme</span>
      <div class="chips">
        <span class="chip" data-theme="light">Light</span>
        <span class="chip" data-theme="dark">Dark</span>
      </div>
    </div>

    <div class="row">
      <button id="resetBtn" class="icon-btn" title="Reset" aria-label="Reset">↺</button>
      <span class="subtle">Preferences are saved on this device</span>
    </div>
  </div>

<script>
  /**********************
   * Demo Data Source
   **********************/
  const allItems = [
    { id: 1,  cat: 'News',   text: 'Cape Town water storage tops 95%', url: '#' },
    { id: 2,  cat: 'Events', text: 'Town Hall today at 15:00 (Auditorium A)', url: '#' },
    { id: 3,  cat: 'Alerts', text: 'Phishing alert: MFA prompts from unknown apps', url: '#' },
    { id: 4,  cat: 'Sports', text: 'Boks vs. Wales Saturday – lineup announced', url: '#' },
    { id: 5,  cat: 'Stocks', text: 'STING ↑ 2.1% after Q3 earnings beat', url: '#' },
    { id: 6,  cat: 'News',   text: 'New Helpdesk portal live – faster ticketing', url: '#' },
    { id: 7,  cat: 'Events', text: 'Wellness Day next Friday – RSVP open', url: '#' },
    { id: 8,  cat: 'Alerts', text: 'VPN maintenance tonight 22:00–23:00 SAST', url: '#' },
  ];
  const categories = ['News', 'Events', 'Alerts', 'Sports', 'Stocks'];

  /**********************
   * Preferences (with defaults)
   **********************/
  const PREF_KEY = 'tickerPrefs.v1';
  const defaultPrefs = {
    enabledCategories: new Set(['News','Events','Alerts','Sports','Stocks']),
    speedSeconds: 35,
    fontPx: 14,
    theme: 'dark',
    paused: false,
    offsetPx: 0
  };

  function loadPrefs() {
    try {
      const raw = localStorage.getItem(PREF_KEY);
      if (!raw) return structuredClone(defaultPrefs);
      const obj = JSON.parse(raw);
      return {
        enabledCategories: new Set(obj.enabledCategories || Array.from(defaultPrefs.enabledCategories)),
        speedSeconds: clamp(+obj.speedSeconds || defaultPrefs.speedSeconds, 10, 60),
        fontPx: clamp(+obj.fontPx || defaultPrefs.fontPx, 12, 20),
        theme: ['light','dark'].includes(obj.theme) ? obj.theme : defaultPrefs.theme,
        paused: !!obj.paused,
        offsetPx: +obj.offsetPx || 0
      };
    } catch {
      return structuredClone(defaultPrefs);
    }
  }

  function savePrefs(p) {
    const obj = {
      enabledCategories: Array.from(p.enabledCategories),
      speedSeconds: p.speedSeconds,
      fontPx: p.fontPx,
      theme: p.theme,
      paused: p.paused,
      offsetPx: p.offsetPx
    };
    localStorage.setItem(PREF_KEY, JSON.stringify(obj));
  }

  const clamp = (n, min, max) => Math.min(max, Math.max(min, n));

  let prefs = loadPrefs();

  /**********************
   * Rendering
   **********************/
  const lane = document.getElementById('tickerLane');

  function buildItem(item) {
    const li = document.createElement('div');
    li.className = 'ticker-item';
    li.setAttribute('role', 'listitem');

    const tag = document.createElement('span');
    tag.className = `tag ${item.cat}`;
    tag.textContent = item.cat;

    const link = document.createElement('a');
    link.href = item.url || '#';
    link.textContent = item.text;
    link.target = '_blank';
    link.rel = 'noopener';

    li.appendChild(tag);
    li.appendChild(link);
    return li;
  }

  function getFilteredItems() {
    return allItems.filter(i => prefs.enabledCategories.has(i.cat));
  }

  // Create seamless loop by duplicating items
  function renderLane() {
    lane.innerHTML = '';
    const filtered = getFilteredItems();

    if (filtered.length === 0) {
      lane.appendChild(Object.assign(document.createElement('div'), {
        className: 'ticker-item',
        textContent: 'No items match your filters.'
      }));
      return;
    }

    const fragment = document.createDocumentFragment();
    filtered.forEach(i => fragment.appendChild(buildItem(i)));
    filtered.forEach(i => fragment.appendChild(buildItem(i))); // duplicate

    lane.appendChild(fragment);
    applyPrefsToDOM();
  }

  /**********************
   * Apply Preferences to UI/DOM
   **********************/
  function applyPrefsToDOM() {
    // theme
    document.body.setAttribute('data-theme', prefs.theme);

    // speed
    document.documentElement.style.setProperty('--speed', `${prefs.speedSeconds}s`);

    // font size
    document.documentElement.style.setProperty('--font-size', `${prefs.fontPx}px`);

    // offset (nudge)
    document.documentElement.style.setProperty('--offset', `${prefs.offsetPx}px`);

    // pause state
    lane.classList.toggle('paused', !!prefs.paused);
    pauseBtn.setAttribute('aria-pressed', prefs.paused ? 'true' : 'false');
    pauseBtn.setAttribute('aria-label', prefs.paused ? 'Play ticker' : 'Pause ticker');
    pauseBtn.title = prefs.paused ? 'Play' : 'Pause';
    pauseBtn.textContent = prefs.paused ? '▶️' : '⏸';
  }

  /**********************
   * Controls & Personalization Panel
   **********************/
  const pauseBtn = document.getElementById('pauseBtn');
  const gearBtn = document.getElementById('gearBtn');
  const panel = document.getElementById('prefsPanel');
  const speedRange = document.getElementById('speedRange');
  const fontRange = document.getElementById('fontRange');
  const categoryChips = document.getElementById('categoryChips');
  const resetBtn = document.getElementById('resetBtn');

  function renderCategoryChips() {
    categoryChips.innerHTML = '';
    categories.forEach(cat => {
      const chip = document.createElement('span');
      chip.className = 'chip' + (prefs.enabledCategories.has(cat) ? ' active' : '');
      chip.textContent = cat;
      chip.setAttribute('role', 'switch');
      chip.setAttribute('aria-checked', prefs.enabledCategories.has(cat) ? 'true' : 'false');
      chip.tabIndex = 0;

      const toggle = () => {
        if (prefs.enabledCategories.has(cat)) {
          prefs.enabledCategories.delete(cat);
        } else {
          prefs.enabledCategories.add(cat);
        }
        chip.classList.toggle('active');
        chip.setAttribute('aria-checked', chip.classList.contains('active') ? 'true' : 'false');
        savePrefs(prefs);
        renderLane();
      };

      chip.addEventListener('click', toggle);
      chip.addEventListener('keydown', (e) => {
        if (e.key === ' ' || e.key === 'Enter') {
          e.preventDefault();
          toggle();
        }
      });

      categoryChips.appendChild(chip);
    });
  }

  function hydratePanel() {
    speedRange.value = prefs.speedSeconds;
    fontRange.value = prefs.fontPx;

    // Theme chips
    panel.querySelectorAll('[data-theme]').forEach(node => {
      node.classList.toggle('active', node.dataset.theme === prefs.theme);
      node.onclick = () => {
        prefs.theme = node.dataset.theme;
        panel.querySelectorAll('[data-theme]').forEach(n => n.classList.remove('active'));
        node.classList.add('active');
        savePrefs(prefs);
        applyPrefsToDOM();
      };
    });
  }

  // Open/close panel — with robust click handling
  function openPanel() {
    panel.classList.add('open');
    panel.hidden = false;
    gearBtn.setAttribute('aria-expanded', 'true');
    hydratePanel();
  }
  function closePanel() {
    panel.classList.remove('open');
    panel.hidden = true;
    gearBtn.setAttribute('aria-expanded', 'false');
  }

  gearBtn.addEventListener('click', (e) => {
    e.stopPropagation(); // prevent document click handler from firing
    panel.classList.contains('open') ? closePanel() : openPanel();
  });

  // Prevent clicks inside the panel from bubbling to document
  panel.addEventListener('click', (e) => {
    e.stopPropagation();
  });

  // Outside click handler (robust with composedPath)
  document.addEventListener('click', (e) => {
    const path = e.composedPath ? e.composedPath() : [];
    const clickedInsidePanel = path.includes(panel) || (e.target.closest && e.target.closest('#prefsPanel'));
    const clickedGear = (e.target === gearBtn) || (e.target.closest && e.target.closest('#gearBtn'));
    if (!clickedInsidePanel && !clickedGear && panel.classList.contains('open')) {
      closePanel();
    }
  });

  // Pause/Play (icon only)
  pauseBtn.addEventListener('click', () => {
    prefs.paused = !prefs.paused;
    savePrefs(prefs);
    applyPrefsToDOM();
  });

  // Input listeners
  speedRange.addEventListener('input', () => {
    prefs.speedSeconds = Number(speedRange.value);
    savePrefs(prefs);
    applyPrefsToDOM();
  });
  fontRange.addEventListener('input', () => {
    prefs.fontPx = Number(fontRange.value);
    savePrefs(prefs);
    applyPrefsToDOM();
  });

  // Reset
  resetBtn.addEventListener('click', () => {
    prefs = structuredClone(defaultPrefs);
    savePrefs(prefs);
    renderCategoryChips();
    renderLane();
    hydratePanel();
  });

  // Boot
  renderCategoryChips();
  renderLane();

  /**********************
   * Hover pause (does not alter saved pause state)
   **********************/
  function onHoverIn() {
    lane.classList.add('hover-paused');
  }
  function onHoverOut() {
    lane.classList.remove('hover-paused');
  }
  // Pause on hover over lane or any child item/link
  lane.addEventListener('mouseenter', onHoverIn, true);
  lane.addEventListener('mouseleave', onHoverOut, true);

  /**********************
   * Keyboard Shortcuts (no visual hints)
   *  Space  → pause/play
   *  ← / →  → nudge scroll
   *  + / –  → speed
   *  [ / ]  → font size
   *  1..5   → toggle categories
   **********************/
  const NUDGE = 40;
  function handleKey(e) {
    const tag = (e.target.tagName || '').toLowerCase();
    if (tag === 'input' || tag === 'textarea') return;

    if (e.code === 'Space') {
      e.preventDefault();
      prefs.paused = !prefs.paused;
      savePrefs(prefs);
      applyPrefsToDOM();
      return;
    }

    if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
      e.preventDefault();
      const delta = (e.key === 'ArrowLeft') ? NUDGE : -NUDGE;
      prefs.offsetPx = (prefs.offsetPx || 0) + delta;
      prefs.offsetPx = Math.max(Math.min(prefs.offsetPx, 100000), -100000);
      savePrefs(prefs);
      applyPrefsToDOM();
      return;
    }

    if (e.key === '+' || e.key === '=') {
      e.preventDefault();
      prefs.speedSeconds = Math.max(10, Math.min(60, prefs.speedSeconds - 5));
      savePrefs(prefs);
      applyPrefsToDOM();
      if (speedRange) speedRange.value = prefs.speedSeconds;
      return;
    }
    if (e.key === '-' || e.key === '_') {
      e.preventDefault();
      prefs.speedSeconds = Math.max(10, Math.min(60, prefs.speedSeconds + 5));
      savePrefs(prefs);
      applyPrefsToDOM();
      if (speedRange) speedRange.value = prefs.speedSeconds;
      return;
    }

    if (e.key === '[') {
      e.preventDefault();
      prefs.fontPx = Math.max(12, Math.min(20, prefs.fontPx - 1));
      savePrefs(prefs);
      applyPrefsToDOM();
      if (fontRange) fontRange.value = prefs.fontPx;
      return;
    }
    if (e.key === ']') {
      e.preventDefault();
      prefs.fontPx = Math.max(12, Math.min(20, prefs.fontPx + 1));
      savePrefs(prefs);
      applyPrefsToDOM();
      if (fontRange) fontRange.value = prefs.fontPx;
      return;
    }

    if (/^[1-5]$/.test(e.key)) {
      const idx = parseInt(e.key, 10) - 1;
      const cat = categories[idx];
      if (cat) {
        e.preventDefault();
        if (prefs.enabledCategories.has(cat)) prefs.enabledCategories.delete(cat);
        else prefs.enabledCategories.add(cat);
        savePrefs(prefs);
        renderCategoryChips();
        renderLane();
      }
    }
  }
  document.addEventListener('keydown', handleKey);
</script>
</body>
</html>
